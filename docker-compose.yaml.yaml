version: '3.8'

services:
  file-shifter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: file-shifter
    restart: unless-stopped
    
    # Environment-Variablen als Key-Value-Paare
    environment:
      # Logging
      LOG_LEVEL: INFO
      
      # Input Directory
      INPUT: /app/input
      
      # Output Targets (JSON-Format f체r komplexe Strukturen)
      OUTPUTS: |
        [
          {
            "path": "/app/output/filesystem1",
            "type": "filesystem"
          },
          {
            "path": "/app/output/filesystem2", 
            "type": "filesystem"
          },
          {
            "path": "s3://my-bucket/output3",
            "type": "s3"
          },
          {
            "path": "sftp://sftp-server/output4",
            "type": "ftp"
          }
        ]
      
      # S3 Configuration
      S3_ENDPOINT: minio:9000
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_REGION: eu-central-1
      S3_USE_SSL: "false"
      
      # FTP Configuration
      FTP_HOST: sftp-server
      FTP_USERNAME: user
      FTP_PASSWORD: password
      FTP_PORT: "22"
    
    # Volumes
    volumes:
      - ./input:/app/input
      - ./output:/app/output
      - ./config:/app/config:ro  # Config-Files readonly
    
    # Netzwerk
    networks:
      - file-shifter-network
    
    # Abh채ngigkeiten (optional - falls MinIO verwendet wird)
    depends_on:
      - minio
      - sftp-server

  # MinIO-Service (Optional - f체r S3-kompatible Storage)
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    networks:
      - file-shifter-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # SFTP-Server (Optional - f체r FTP-Tests)
  sftp-server:
    image: atmoz/sftp:latest
    container_name: sftp-server
    restart: unless-stopped
    environment:
      - SFTP_USERS=user:password:1001
    volumes:
      - sftp_data:/home/user/upload
    ports:
      - "2222:22"
    networks:
      - file-shifter-network

networks:
  file-shifter-network:
    driver: bridge

volumes:
  minio_data:
  sftp_data: